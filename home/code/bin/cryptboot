#!/bin/bash

set -e -o pipefail

cryptname=cryptboot
device="$(readlink -f /dev/disk/by-partlabel/Boot)"
status=$1
case $status in
status)
    exec cryptsetup status "$cryptname"
    ;;
mount)
    if ! cryptsetup status "$cryptname" &>/dev/null; then
        cryptsetup luksOpen "$device" "$cryptname"
    fi
    if ! findmnt /boot &>/dev/null; then
        mount /boot
    fi
    if ! findmnt /boot/efi &>/dev/null; then
        mount /boot/efi
    fi
    exit 0
    ;;
umount)
    if findmnt /boot/efi &>/dev/null; then
        umount /boot/efi
    fi
    if findmnt /boot &>/dev/null; then
        umount /boot
    fi
    if cryptsetup status "$cryptname" &>/dev/null; then
        cryptsetup close "$cryptname"
    fi
    ;;
*)
    echo "usage: $0 <action>" >&2
    exit 1
    ;;
esac

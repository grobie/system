#!/bin/bash

set -e -o pipefail

cryptname=cryptboot
uuid="$(grep "$cryptname" /etc/crypttab | cut -f2 | cut -d= -f2)"
device="$(readlink -f "/dev/disk/by-uuid/$uuid")"
status=$1
case $status in
status)
    exec cryptsetup status "$cryptname"
    ;;
mount)
    cryptsetup luksOpen "$device" "$cryptname"
    if ! findmnt /boot &>/dev/null; then
        mount /boot
    fi
    if ! findmnt /boot/efi &>/dev/null; then
        mount /boot/efi
    fi
    exit 0
    ;;
umount)
    if findmnt /boot/efi &>/dev/null; then
        umount /boot/efi
    fi
    if findmnt /boot &>/dev/null; then
        umount /boot
    fi
    if cryptsetup status "$cryptname" &>/dev/null; then
        cryptsetup close "$cryptname"
    fi
    ;;
*)
    echo "usage: $0 <action>" >&2
    exit 1
    ;;
esac
